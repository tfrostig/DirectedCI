---
title: "DirectedCI Analysis: GLP-1 Receptor Agonists and Cancer Risk"
subtitle: "Dai et al. (JAMA Oncology 2025)"
author: "DirectedCI Package Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 7
)
```

# 1. Setup

```{r load-packages}
devtools::load_all("..", quiet = TRUE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
```

---

# 2. Data Extraction

```{r extract-data}
# Cancer endpoints from Figure 3 of Dai et al. (2025)
cancers <- data.frame(
  name = c("Overall Cancer", "Endometrial", "Ovarian", "Meningioma", "Colorectal",
           "Thyroid", "Prostate", "Breast", "Lung", "Pancreatic",
           "Kidney", "Liver", "Multiple Myeloma", "Bladder", "Upper GI"),
  HR = c(0.83, 0.75, 0.53, 0.69, 0.88, 0.77, 0.91, 0.86, 0.76, 0.84, 1.38, 0.91, 0.79, 0.97, 0.60),
  CI_lower = c(0.76, 0.57, 0.29, 0.48, 0.64, 0.54, 0.73, 0.71, 0.55, 0.54, 0.99, 0.60, 0.46, 0.63, 0.29),
  CI_upper = c(0.91, 0.99, 0.96, 0.97, 1.22, 1.11, 1.15, 1.03, 1.04, 1.30, 1.93, 1.38, 1.35, 1.50, 1.24),
  n_users = c(891, 86, 17, 55, 70, 54, 151, 200, 70, 37, 83, 44, 24, 41, 12),
  n_nonusers = c(1022, 115, 32, 76, 76, 67, 145, 234, 88, 42, 58, 46, 29, 40, 19),
  stringsAsFactors = FALSE
)

# Calculate log-scale statistics
cancers <- cancers %>%
  mutate(
    log_HR = log(HR),
    SE = (log(CI_upper) - log(CI_lower)) / (2 * 1.96),
    z_stat = log_HR / SE,
    significant = abs(z_stat) > 1.96,
    direction = ifelse(z_stat < 0, "Protective", "Harmful")
  )

cancers %>%
  select(name, HR, CI_lower, CI_upper, z_stat, significant) %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%
  kable(caption = "Cancer Endpoints from Dai et al. (2025)",
        col.names = c("Cancer", "HR", "CI Lower", "CI Upper", "z", "Sig?")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(cancers$significant), bold = TRUE)
```

---

# 3. Parameters

```{r params}
params <- data.frame(
  Parameter = c("Alpha", "Critical value (ct)", "Inflation (r)", "Total endpoints (m)",
                "Selected endpoints (R)", "BY-adjusted alpha", "Preferred direction"),
  Value = c("0.05", "1.96", "1.3", as.character(nrow(cancers)),
            as.character(sum(cancers$significant)),
            round((sum(cancers$significant) / nrow(cancers)) * 0.05, 5),
            "Negative (HR < 1)")
)

kable(params) %>% kable_styling(bootstrap_options = c("striped"), full_width = FALSE)

alpha <- 0.05
ct <- qnorm(1 - alpha / 2)
r <- 1.3
m <- nrow(cancers)
R <- sum(cancers$significant)
by_alpha <- (R / m) * alpha
```

---

# 4. Compute DirectedCI

```{r compute-cis}
compute_all_cis <- function(log_hr, se, ct, r, alpha) {
  z <- log_hr / se

  std_ci_log <- c(log_hr - 1.96 * se, log_hr + 1.96 * se)
  dp_marg_z <- dn_marginal_ci(y = z, r_l = r, alpha = alpha)
  dp_marg_log <- dp_marg_z * se
  mp_marg_z <- mp_marginal_ci(y = z, r = r, alpha = alpha)
  mp_marg_log <- mp_marg_z * se

  if (abs(z) > ct) {
    dp_cond_z <- dn_conditional_ci(y = z, r = r, ct = ct, alpha = alpha)
    dp_cond_log <- dp_cond_z * se
    short_cond_z <- shortest_conditional_ci(y = z, ct = ct, alpha = alpha)
    short_cond_log <- short_cond_z * se
  } else {
    dp_cond_log <- c(NA, NA)
    short_cond_log <- c(NA, NA)
  }

  list(
    z = z, significant = abs(z) > ct,
    std_log = std_ci_log, dp_marg_log = dp_marg_log, mp_marg_log = mp_marg_log,
    dp_cond_log = dp_cond_log, short_cond_log = short_cond_log
  )
}

results <- lapply(1:nrow(cancers), function(i) {
  res <- compute_all_cis(cancers$log_HR[i], cancers$SE[i], ct, r, alpha)

  data.frame(
    cancer = cancers$name[i], HR = cancers$HR[i], z = res$z,
    significant = res$significant, direction = cancers$direction[i],
    std_lower = exp(res$std_log[1]), std_upper = exp(res$std_log[2]),
    dp_marg_lower = exp(res$dp_marg_log[1]), dp_marg_upper = exp(res$dp_marg_log[2]),
    mp_marg_lower = exp(res$mp_marg_log[1]), mp_marg_upper = exp(res$mp_marg_log[2]),
    dp_cond_lower = if(!is.na(res$dp_cond_log[1])) exp(res$dp_cond_log[1]) else NA,
    dp_cond_upper = if(!is.na(res$dp_cond_log[2])) exp(res$dp_cond_log[2]) else NA,
    short_cond_lower = if(!is.na(res$short_cond_log[1])) exp(res$short_cond_log[1]) else NA,
    short_cond_upper = if(!is.na(res$short_cond_log[2])) exp(res$short_cond_log[2]) else NA
  )
})

results_df <- do.call(rbind, results)

results_df %>%
  select(cancer, HR, z, significant, std_lower, std_upper, dp_marg_lower, dp_marg_upper) %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%
  kable(caption = "DirectedCI Results (HR Scale)",
        col.names = c("Cancer", "HR", "z", "Sig?", "Std L", "Std U", "DP- L", "DP- U")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 11) %>%
  row_spec(which(results_df$significant & results_df$direction == "Protective"),
           bold = TRUE, background = "#C8E6C9") %>%
  row_spec(which(results_df$cancer == "Kidney"), bold = TRUE, background = "#FFCDD2")
```

---

# 5. Visualizations

## 5.1 Forest Plot: Standard CIs

```{r forest-all, fig.height=10, fig.width=11}
results_df <- results_df %>%
  mutate(
    effect_type = case_when(
      significant & direction == "Protective" ~ "Significant Protection",
      significant & direction == "Harmful" ~ "Significant Harm",
      direction == "Protective" ~ "Non-sig. Protection",
      TRUE ~ "Non-sig. Harm"
    )
  )

ggplot(results_df, aes(y = reorder(cancer, -HR), x = HR)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray40", linewidth = 0.8) +
  geom_errorbarh(aes(xmin = std_lower, xmax = std_upper),
                 height = 0.3, linewidth = 0.9, color = "#666666") +
  geom_point(aes(color = effect_type, size = significant)) +
  scale_color_manual(values = c("Significant Protection" = "#2E7D32",
                                "Non-sig. Protection" = "#81C784",
                                "Non-sig. Harm" = "#E57373",
                                "Significant Harm" = "#C62828")) +
  scale_size_manual(values = c("TRUE" = 4, "FALSE" = 2.5)) +
  scale_x_continuous(breaks = seq(0.2, 2.0, 0.2), limits = c(0.2, 2.1)) +
  labs(
    title = "GLP-1RA Use and Cancer Risk: Standard 95% CIs",
    subtitle = "Dai et al. (JAMA Oncology 2025)",
    x = "Hazard Ratio (95% CI)", y = "", color = "Effect Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom", panel.grid.minor = element_blank(),
        plot.title = element_text(face = "bold")) +
  guides(size = "none")
```

## 5.2 CI Comparison: Significant Protective Endpoints

```{r comprehensive-comparison, fig.height=9, fig.width=14}
# Exclude kidney cancer (contradicts preferred direction)
sig_prot_idx <- which(cancers$significant & cancers$z_stat < 0)

if (length(sig_prot_idx) > 0) {
  plot_ci_comparison(
    estimates = cancers$log_HR[sig_prot_idx],
    se = cancers$SE[sig_prot_idx],
    names = cancers$name[sig_prot_idx],
    alpha = alpha, m = m, R = R, r = r, ct = ct,
    methods = c("by_standard", "by_dp", "by_mp",
                "cond_standard", "cond_dp", "cond_mp"),
    direction = "negative",
    title = "GLP-1RA Cancer Protection: CI Comparison",
    xlab = "log(Hazard Ratio)"
  )
}
```

---

# Session Information

```{r session-info}
sessionInfo()
```
