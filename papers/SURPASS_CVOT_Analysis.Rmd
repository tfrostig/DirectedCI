---
title: "DirectedCI Analysis: SURPASS-CVOT Trial"
subtitle: "Cardiovascular Outcomes with Tirzepatide versus Dulaglutide"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 7)
```

# 1. Setup

```{r load-packages}
devtools::load_all("..", quiet = TRUE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
```

**Study**: SURPASS-CVOT (Nicholls et al., NEJM 2025) - Tirzepatide vs Dulaglutide in T2D with ASCVD (n=13,165)

**Preferred direction**: NEGATIVE (HR < 1, difference < 0 means tirzepatide is better)

---

# 2. Data Extraction

## 2.1 Ratio Endpoints (Hazard Ratios)

```{r extract-ratio}
ratio_endpoints <- data.frame(
  name = c("MACE-3 (Primary)", "CV Death", "Myocardial Infarction", "Stroke",
           "All-Cause Death", "4-Point MACE", "CV Death or HF Hosp"),
  HR = c(0.92, 0.89, 0.86, 0.91, 0.84, 0.88, 0.91),
  CI_lower = c(0.83, 0.77, 0.74, 0.76, 0.75, 0.81, 0.81),
  CI_upper = c(1.01, 1.02, 1.00, 1.09, 0.94, 0.96, 1.03),
  stringsAsFactors = FALSE
)

ratio_endpoints <- ratio_endpoints %>%
  mutate(
    log_HR = log(HR),
    SE = (log(CI_upper) - log(CI_lower)) / (2 * 1.96),
    z_stat = log_HR / SE,
    significant = abs(z_stat) > 1.96
  )

kable(ratio_endpoints %>% select(name, HR, CI_lower, CI_upper, z_stat, significant) %>%
        mutate(z_stat = round(z_stat, 3)),
      col.names = c("Endpoint", "HR", "CI Lower", "CI Upper", "z", "Sig?")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## 2.2 Difference Endpoints

```{r extract-diff}
diff_endpoints <- data.frame(
  name = c("HbA1c Change (36 mo)", "Body Weight Change (36 mo)", "Triglycerides Change (24 mo)",
           "Systolic BP Change (36 mo)", "eGFR Change (36 mo)", "LDL Cholesterol Change (24 mo)"),
  estimate = c(-0.78, -6.8, -15.6, -2.1, 3.17, 1.3),
  CI_lower = c(-0.84, -7.1, -16.9, -2.6, 2.09, -0.2),
  CI_upper = c(-0.72, -6.5, -14.3, -1.5, 4.26, 2.8),
  units = c("pp", "%", "pp", "mmHg", "ml/min/1.73m2", "pp"),
  preferred_negative = c(TRUE, TRUE, TRUE, TRUE, FALSE, TRUE),
  stringsAsFactors = FALSE
)

diff_endpoints <- diff_endpoints %>%
  mutate(
    SE = (CI_upper - CI_lower) / (2 * 1.96),
    z_stat = estimate / SE,
    significant = abs(z_stat) > 1.96
  )

kable(diff_endpoints %>% select(name, estimate, CI_lower, CI_upper, z_stat, significant) %>%
        mutate(z_stat = round(z_stat, 2)),
      col.names = c("Endpoint", "Diff", "CI Lower", "CI Upper", "z", "Sig?")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

---

# 3. Analysis Parameters

```{r params}
# Parameters
alpha <- 0.05
ct <- qnorm(1 - alpha / 2)
r <- 1.3
m <- nrow(ratio_endpoints) + nrow(diff_endpoints)
R <- sum(ratio_endpoints$significant) + sum(diff_endpoints$significant)
by_alpha <- (R / m) * alpha

params <- data.frame(
  Parameter = c("alpha", "ct (critical value)", "r (inflation)", "m (total endpoints)",
                "R (selected)", "BY-alpha"),
  Value = c(alpha, round(ct, 3), r, m, R, round(by_alpha, 5))
)
kable(params) %>% kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

---

# 4. Compute DirectedCI

```{r compute-cis}
compute_cis <- function(estimate, se, ct, r, alpha, by_alpha, direction = "negative") {
  z <- estimate / se
  std_ci <- c(estimate - 1.96 * se, estimate + 1.96 * se)
  by_z <- qnorm(1 - by_alpha / 2)
  by_std <- c(estimate - by_z * se, estimate + by_z * se)

  if (direction == "negative") {
    dp_marg_z <- dn_marginal_ci(y = z, r_l = r, alpha = alpha)
    by_dp_marg_z <- dn_marginal_ci(y = z, r_l = r, alpha = by_alpha)
  } else {
    dp_marg_z <- dp_marginal_ci(y = z, r_l = r, alpha = alpha)
    by_dp_marg_z <- dp_marginal_ci(y = z, r_l = r, alpha = by_alpha)
  }

  if (abs(z) > ct) {
    if (direction == "negative") {
      dp_cond_z <- dn_conditional_ci(y = z, r = r, ct = ct, alpha = alpha)
    } else {
      dp_cond_z <- dp_conditional_ci(y = z, r = r, ct = ct, alpha = alpha)
    }
    short_cond_z <- shortest_conditional_ci(y = z, ct = ct, alpha = alpha)
  } else {
    dp_cond_z <- short_cond_z <- c(NA, NA)
  }

  list(z = z, significant = abs(z) > ct,
       std = std_ci, by_std = by_std,
       dp_marg = dp_marg_z * se, by_dp_marg = by_dp_marg_z * se,
       dp_cond = if(!any(is.na(dp_cond_z))) dp_cond_z * se else c(NA, NA),
       short_cond = if(!any(is.na(short_cond_z))) short_cond_z * se else c(NA, NA))
}

# Compute for ratio endpoints
ratio_results <- lapply(1:nrow(ratio_endpoints), function(i) {
  res <- compute_cis(ratio_endpoints$log_HR[i], ratio_endpoints$SE[i], ct, r, alpha, by_alpha, "negative")
  data.frame(
    endpoint = ratio_endpoints$name[i], type = "Ratio",
    estimate = ratio_endpoints$HR[i], estimate_raw = ratio_endpoints$log_HR[i], se = ratio_endpoints$SE[i],
    z = res$z, significant = res$significant,
    std_lower = exp(res$std[1]), std_upper = exp(res$std[2]),
    by_std_lower = exp(res$by_std[1]), by_std_upper = exp(res$by_std[2]),
    by_dp_lower = exp(res$by_dp_marg[1]), by_dp_upper = exp(res$by_dp_marg[2]),
    dp_cond_lower = if(!is.na(res$dp_cond[1])) exp(res$dp_cond[1]) else NA,
    dp_cond_upper = if(!is.na(res$dp_cond[2])) exp(res$dp_cond[2]) else NA
  )
})
ratio_results_df <- do.call(rbind, ratio_results)

# Compute for difference endpoints
diff_results <- lapply(1:nrow(diff_endpoints), function(i) {
  direction <- ifelse(diff_endpoints$preferred_negative[i], "negative", "positive")
  res <- compute_cis(diff_endpoints$estimate[i], diff_endpoints$SE[i], ct, r, alpha, by_alpha, direction)
  data.frame(
    endpoint = diff_endpoints$name[i], type = "Difference",
    estimate = diff_endpoints$estimate[i], estimate_raw = diff_endpoints$estimate[i], se = diff_endpoints$SE[i],
    z = res$z, significant = res$significant,
    std_lower = res$std[1], std_upper = res$std[2],
    by_std_lower = res$by_std[1], by_std_upper = res$by_std[2],
    by_dp_lower = res$by_dp_marg[1], by_dp_upper = res$by_dp_marg[2],
    dp_cond_lower = res$dp_cond[1], dp_cond_upper = res$dp_cond[2]
  )
})
diff_results_df <- do.call(rbind, diff_results)
all_results_df <- rbind(ratio_results_df, diff_results_df)
```

## 4.1 Results - Ratio Endpoints

```{r results-ratio}
ratio_results_df %>%
  select(endpoint, estimate, z, significant, std_lower, std_upper, by_dp_lower, by_dp_upper, dp_cond_lower, dp_cond_upper) %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%
  kable(col.names = c("Endpoint", "HR", "z", "Sig?", "Std L", "Std U", "BY DP- L", "BY DP- U", "Cond DP- L", "Cond DP- U")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 11) %>%
  row_spec(which(ratio_results_df$significant), bold = TRUE, background = "#E8F5E9")
```

## 4.2 Results - Difference Endpoints

```{r results-diff}
diff_results_df %>%
  select(endpoint, estimate, z, significant, std_lower, std_upper, by_dp_lower, by_dp_upper, dp_cond_lower, dp_cond_upper) %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%
  kable(col.names = c("Endpoint", "Diff", "z", "Sig?", "Std L", "Std U", "BY DP L", "BY DP U", "Cond DP L", "Cond DP U")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 11) %>%
  row_spec(which(diff_results_df$significant), bold = TRUE, background = "#E8F5E9")
```

---

# 5. Visualizations

## 5.1 Ratio Endpoints - Forest Plot

```{r forest-ratio, fig.height=7}
ggplot(ratio_results_df, aes(y = reorder(endpoint, estimate), x = estimate)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray40") +
  geom_errorbarh(aes(xmin = std_lower, xmax = std_upper), height = 0.3, linewidth = 1, color = "#d7191c") +
  geom_point(aes(shape = significant), size = 3.5, color = "#d7191c") +
  scale_shape_manual(values = c("TRUE" = 16, "FALSE" = 1)) +
  scale_x_continuous(breaks = seq(0.7, 1.1, 0.1), limits = c(0.65, 1.15)) +
  labs(title = "SURPASS-CVOT: Ratio Endpoints", x = "Hazard Ratio (95% CI)", y = "") +
  theme_minimal(base_size = 14) + theme(legend.position = "none")
```

## 5.2 CI Comparison - Ratio Endpoints

```{r ci-comparison-ratio, fig.height=9, fig.width=14}
sig_ratio_idx <- which(ratio_endpoints$significant)
if (length(sig_ratio_idx) > 0) {
  plot_ci_comparison(
    estimates = ratio_endpoints$log_HR[sig_ratio_idx],
    se = ratio_endpoints$SE[sig_ratio_idx],
    names = ratio_endpoints$name[sig_ratio_idx],
    alpha = alpha, m = m, R = R, r = r, ct = ct,
    methods = c("by_standard", "by_dp", "by_mp", "cond_standard", "cond_dp", "cond_mp"),
    direction = "negative",
    title = paste0("Ratio Endpoints (m=", m, ", R=", R, ")"),
    xlab = "log(Hazard Ratio)"
  )
}
```

## 5.3 CI Comparison - Difference Endpoints

```{r ci-comparison-diff, fig.height=9, fig.width=14}
sig_diff_idx <- which(diff_endpoints$significant)
if (length(sig_diff_idx) > 0) {
  # For difference endpoints, handle mixed directions
  # Most prefer negative (lower is better), except eGFR prefers positive
  plot_ci_comparison(
    estimates = diff_endpoints$estimate[sig_diff_idx],
    se = diff_endpoints$SE[sig_diff_idx],
    names = diff_endpoints$name[sig_diff_idx],
    alpha = alpha, m = m, R = R, r = r, ct = ct,
    methods = c("by_standard", "by_dp", "by_mp", "cond_standard", "cond_dp", "cond_mp"),
    direction = "negative",
    title = paste0("Difference Endpoints (m=", m, ", R=", R, ")"),
    xlab = "Difference (Tirzepatide - Dulaglutide)"
  )
}
```

---

# Session Info

```{r session-info}
sessionInfo()
```
