---
title: "DirectedCI Analysis: Manson et al. (2019) Secondary Endpoints"
subtitle: "VITAL Trial - Vitamin D and Cardiovascular Disease Prevention"
author: "DirectedCI Package Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: show
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 7
)
```

# 1. Setup

```{r load-packages}
devtools::load_all("..", quiet = TRUE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
```

---

# 2. Data Extraction

```{r extract-data}
# Manson et al. (2019) secondary endpoints - 22 endpoints
dat <- data.frame(
  index = seq(1, 22, 1),
  y     = c(0.93, 0.72, 1.04, 0.96, 0.78, 0.99, 0.83, 0.96, 1.32, 0.76, 0.50, 1.10, 0.90, 1.15, 1.23, 0.97, 1.02, 0.89, 0.72, 1.13, 0.93, 0.97),
  lower = c(0.82, 0.59, 0.83, 0.76, 0.63, 0.73, 0.71, 0.74, 0.72, 0.49, 0.26, 0.60, 0.70, 0.94, 0.83, 0.79, 0.90, 0.76, 0.55, 1.00, 0.73, 0.84),
  upper = c(1.04, 0.90, 1.31, 1.21, 0.95, 1.33, 0.97, 1.24, 2.39, 1.16, 0.97, 2.01, 1.16, 1.39, 1.83, 1.20, 1.15, 1.05, 0.93, 1.28, 1.19, 1.12)
)

m <- dim(dat)[1]

# Extract the SE on the log-scale
ME_logscale <- (-log(dat$lower) + log(dat$upper)) / 2
SE_logscale <- ME_logscale / qnorm(0.975)

dat <- dat %>%
  mutate(
    log_HR = log(y),
    SE = SE_logscale,
    z_stat = log_HR / SE,
    significant = abs(z_stat) > qnorm(0.975)
  )

dat %>%
  select(index, y, lower, upper, z_stat, significant) %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%
  kable(caption = "Manson et al. (2019) Secondary Endpoints",
        col.names = c("Index", "HR", "CI Lower", "CI Upper", "z", "Sig?")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(dat$significant), bold = TRUE)
```

---

# 3. Parameters

```{r params}
alpha <- 0.05
m <- nrow(dat)
ct <- qnorm(1 - alpha / 2)
r <- 1.3
R <- sum(dat$significant)
by_alpha <- (R / m) * alpha

params <- data.frame(
  Parameter = c("Alpha", "Critical value (ct)", "Inflation (r)", "Total endpoints (m)",
                "Selected endpoints (R)", "BY-adjusted alpha", "Preferred direction"),
  Value = c("0.05", round(ct, 3), "1.3", m, R, round(by_alpha, 5), "Negative (HR < 1)")
)

kable(params) %>% kable_styling(bootstrap_options = c("striped"), full_width = FALSE)
```

---

# 4. Compute DirectedCI

```{r compute-cis}
bonf_z <- qnorm(1 - alpha / (2 * m))
by_z <- qnorm(1 - by_alpha / 2)

results <- dat %>%
  mutate(
    std_lower = y * exp(-qnorm(0.975) * SE),
    std_upper = y * exp(qnorm(0.975) * SE),
    bonf_lower = y * exp(-bonf_z * SE),
    bonf_upper = y * exp(bonf_z * SE)
  )

results$by_std_lower <- NA
results$by_std_upper <- NA
results$by_dp_lower <- NA
results$by_dp_upper <- NA
results$cond_dp_lower <- NA
results$cond_dp_upper <- NA

for (i in 1:nrow(results)) {
  z <- results$z_stat[i]
  se <- results$SE[i]
  hr <- results$y[i]

  if (results$significant[i]) {
    results$by_std_lower[i] <- hr * exp(-by_z * se)
    results$by_std_upper[i] <- hr * exp(by_z * se)

    by_dp_z <- tryCatch({
      dn_marginal_ci(z, r_l = r, alpha = by_alpha)
    }, error = function(e) c(NA, NA))
    results$by_dp_lower[i] <- exp(by_dp_z[1] * se)
    results$by_dp_upper[i] <- exp(by_dp_z[2] * se)

    cond_dp_z <- tryCatch({
      dn_conditional_ci(z, ct = ct, r = r, alpha = alpha)
    }, error = function(e) c(NA, NA))
    results$cond_dp_lower[i] <- exp(cond_dp_z[1] * se)
    results$cond_dp_upper[i] <- exp(cond_dp_z[2] * se)
  }
}

results %>%
  filter(significant) %>%
  select(index, y, z_stat, std_lower, std_upper, by_dp_lower, by_dp_upper, cond_dp_lower, cond_dp_upper) %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%
  kable(caption = "CI Comparison for Selected Endpoints",
        col.names = c("Index", "HR", "z", "Std L", "Std U", "BY DP- L", "BY DP- U", "Cond DP- L", "Cond DP- U")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

---

# 5. Visualizations

## 5.1 BY-Adjusted CIs

```{r figure-3, fig.width=12, fig.height=8}
plot_data <- results %>%
  select(index, y, significant,
         std_lower, std_upper,
         bonf_lower, bonf_upper,
         by_std_lower, by_std_upper,
         by_dp_lower, by_dp_upper) %>%
  arrange(y) %>%
  mutate(rank = row_number())

ci_long_fig3 <- plot_data %>%
  pivot_longer(
    cols = c(std_lower, std_upper, bonf_lower, bonf_upper,
             by_std_lower, by_std_upper, by_dp_lower, by_dp_upper),
    names_to = c("method", "bound"),
    names_pattern = "(.*)_(lower|upper)",
    values_to = "value"
  ) %>%
  pivot_wider(names_from = bound, values_from = value) %>%
  filter(!is.na(lower) & !is.na(upper)) %>%
  mutate(
    method_label = case_when(
      method == "std" ~ "Unadjusted",
      method == "bonf" ~ "Bonferroni",
      method == "by_std" ~ "BY Unadjusted",
      method == "by_dp" ~ "BY DP-"
    ),
    method_label = factor(method_label, levels = c("Unadjusted", "Bonferroni", "BY Unadjusted", "BY DP-"))
  )

method_colors_fig3 <- c("Unadjusted" = "#d7191c", "Bonferroni" = "gray50",
                        "BY Unadjusted" = "#2b83ba", "BY DP-" = "#00CED1")
method_linetypes <- c("Unadjusted" = "solid", "Bonferroni" = "dotdash",
                      "BY Unadjusted" = "solid", "BY DP-" = "solid")

ci_long_fig3 <- ci_long_fig3 %>%
  mutate(x_offset = case_when(
    method_label == "Unadjusted" ~ -0.25,
    method_label == "Bonferroni" ~ -0.08,
    method_label == "BY Unadjusted" ~ 0.08,
    method_label == "BY DP-" ~ 0.25
  ),
  rank_adj = rank + x_offset)

p1 <- ggplot(ci_long_fig3, aes(x = rank_adj, color = method_label, linetype = method_label)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_segment(aes(xend = rank_adj, y = lower, yend = upper), linewidth = 0.9) +
  geom_point(data = filter(ci_long_fig3, method_label == "Unadjusted"),
             aes(y = y), color = "#d7191c", shape = 15, size = 3) +
  scale_color_manual(values = method_colors_fig3, name = "CI Method") +
  scale_linetype_manual(values = method_linetypes, name = "CI Method") +
  scale_x_continuous(breaks = 1:m) +
  scale_y_continuous(breaks = seq(0, 2.5, 0.25), limits = c(0.2, 2.5)) +
  labs(
    title = "BY-Adjusted Confidence Intervals",
    subtitle = paste0("Manson et al. (2019) | ", m, " endpoints | ", R, " selected"),
    x = "Endpoint (ordered by HR)", y = "Hazard Ratio"
  ) +
  theme_bw(base_size = 12) +
  theme(plot.title = element_text(face = "bold"),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

print(p1)

# Save to figures folder
ggsave("figures/manson_by_adjusted_cis.png", p1, width = 12, height = 8, dpi = 300)
ggsave("figures/manson_by_adjusted_cis.pdf", p1, width = 12, height = 8)
```

## 5.2 Conditional CIs (Selected Endpoints)

```{r figure-4, fig.width=12, fig.height=10}
selected_data <- results %>%
  filter(significant) %>%
  select(index, y,
         std_lower, std_upper,
         by_dp_lower, by_dp_upper,
         cond_dp_lower, cond_dp_upper)

ci_long <- selected_data %>%
  pivot_longer(
    cols = c(std_lower, std_upper, by_dp_lower, by_dp_upper, cond_dp_lower, cond_dp_upper),
    names_to = c("method", "bound"),
    names_pattern = "(.*)_(lower|upper)",
    values_to = "value"
  ) %>%
  pivot_wider(names_from = bound, values_from = value) %>%
  mutate(
    method_label = case_when(
      method == "std" ~ "Unadjusted",
      method == "by_dp" ~ "BY DP-",
      method == "cond_dp" ~ "Conditional DP-"
    ),
    method_label = factor(method_label, levels = c("Unadjusted", "BY DP-", "Conditional DP-"))
  )

method_colors <- c("Unadjusted" = "#d7191c", "BY DP-" = "#00CED1", "Conditional DP-" = "#000000")

p2 <- ggplot(ci_long, aes(y = factor(index), x = y, color = method_label)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray50", linewidth = 0.5) +
  geom_errorbarh(aes(xmin = lower, xmax = upper),
                 height = 0.3, linewidth = 0.9,
                 position = position_dodge(width = 0.6)) +
  geom_point(size = 3, shape = 15, position = position_dodge(width = 0.6)) +
  scale_color_manual(values = method_colors, name = "") +
  scale_x_continuous(breaks = seq(0.2, 1.2, 0.1), limits = c(0.2, 1.3)) +
  labs(
    title = "Conditional CI Comparison (Selected Endpoints)",
    subtitle = paste0("Manson et al. (2019) | ", R, " endpoints with p < 0.05"),
    x = "Hazard Ratio", y = "Endpoint Index"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom",
        plot.title = element_text(face = "bold"),
        panel.grid.minor = element_blank())

print(p2)

# Save to figures folder
ggsave("figures/manson_conditional_cis.png", p2, width = 12, height = 10, dpi = 300)
ggsave("figures/manson_conditional_cis.pdf", p2, width = 12, height = 10)
```

## 5.3 CI Comparison using plot_ci_comparison

```{r figure-5, fig.width=14, fig.height=9}
sig_idx <- which(dat$significant & dat$z_stat < 0)

if (length(sig_idx) > 0) {
  p3 <- plot_ci_comparison(
    estimates = dat$log_HR[sig_idx],
    se = dat$SE[sig_idx],
    names = paste0("Endpoint ", dat$index[sig_idx]),
    alpha = alpha, m = m, R = R, r = r, ct = ct,
    methods = c("by_standard", "by_dp", "by_mp",
                "cond_standard", "cond_dp", "cond_mp"),
    direction = "negative",
    title = paste0("Manson et al. (2019): CI Comparison (m=", m, ", R=", R, ")"),
    xlab = "log(Hazard Ratio)"
  )

  # Save to figures folder
  ggsave("figures/manson_ci_comparison.png", p3, width = 14, height = 9, dpi = 300)
  ggsave("figures/manson_ci_comparison.pdf", p3, width = 14, height = 9)
}
```

---

# Session Information

```{r session-info}
sessionInfo()
```
