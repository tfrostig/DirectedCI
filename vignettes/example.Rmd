---
title: "Konstantopoulos (2011): Modified School Calendar Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Konstantopoulos (2011) Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(DirectedCI)
library(metafor)
library(dplyr)
```

# Helper: Combined CI Plotting Function

We provide a function that *plots both the marginal and conditional Direction-Preferring CIs together*.

```{r}
plot_dp_forest <- function(df,
                           study_id    = "study",
                           estimate    = "effect_mean",
                           se_var      = "effect_se",
                           marg_L      = "marginal_L",
                           marg_U      = "marginal_U",
                           cond_L      = "cond_L",
                           cond_U      = "cond_U",
                           title_label = "Direction-Preferring Confidence Intervals") {

  # Build a long-format CI table (mp/std/unadjusted not needed here)
  marginal_df <- df %>% 
    mutate(type = "Marginal DP+",
           lower = .data[[marg_L]],
           upper = .data[[marg_U]],
           setting = "BY Adjusted CIs")

  conditional_df <- df %>%
    mutate(type = "Conditional DP+",
           lower = .data[[cond_L]],
           upper = .data[[cond_U]],
           setting = "Conditional CIs")

  # Combine them
  ci_long <- bind_rows(marginal_df, conditional_df) %>%
    mutate(setting = factor(setting, 
                            levels = c("BY Adjusted CIs", "Conditional CIs"),
                            ordered = TRUE),
           type = factor(type, levels = c("Marginal DP+", "Conditional DP+")))

  # Colors
  color_vec <- c("Marginal DP+" = "#1F77B4",
                 "Conditional DP+" = "#D62728")

  # Build the plot
  ggplot(ci_long,
         aes(x = factor(.data[[study_id]]),
             y = .data[[estimate]],
             color = type)) +

    geom_hline(yintercept = 0, linewidth = 0.6, alpha = 0.6) +

    geom_errorbar(aes(ymin = lower, ymax = upper),
                  position = position_dodge2(width = 0.8),
                  linewidth = 1.0) +

    geom_point(position = position_dodge2(width = 0.8),
               size = 3) +

    facet_grid(. ~ setting) +

    scale_color_manual(values = color_vec, name = "") +

    labs(
      x = "Study",
      y = expression(paste(theta)),
      title = title_label
    ) +

    theme_minimal(base_size = 16) +
    theme(
      legend.position   = "bottom",
      legend.title      = element_blank(),
      axis.text.x       = element_text(size = 12, hjust = 1),
      axis.text.y       = element_text(size = 12),
      axis.title        = element_text(size = 16),
      title             = element_text(size = 18, face = "bold"),
      strip.text        = element_text(size = 14),
      panel.spacing.x   = unit(2, "lines")
    ) +

    coord_flip()
}

```

---

# 1. Introduction

We analyze the data in **Konstantopoulos (2011)**, which evaluated a *modified school calendar*
(shorter but more frequent academic breaks) and its influence on student performance.

Each study reports standardized mean differences following:

\[
X_i \sim N(\theta_i, 1).
\]

We construct confidence intervals using:

* **Marginal Direction-Preferring (DP+) CIs (BY05 adjusted)**
* **Conditional Direction-Preferring (DP+) CIs**

---

# 2. Loading and Preprocessing the Data

```{r}
dat <- get(data(dat.konstantopoulos2011))

# Standardized effects
standardized_effect <- as.vector(dat$yi / sqrt(dat$vi))

num_studies <- length(standardized_effect)
alpha <- 0.05

# Two-sided test p-values
p_right_tail <- pnorm(standardized_effect, lower.tail = FALSE)

selection_indices <- which(p_right_tail <= alpha/2 |
                           p_right_tail >= 1 - alpha/2)

length(selection_indices)
```

Extract mean and standard error for selected studies:

```{r}
selected_means <- as.vector(dat$yi)[selection_indices]
selected_ses   <- as.vector(sqrt(dat$vi))[selection_indices]
```

---

# 3. Ordering Studies for Display

```{r}
order_indices <- order(selected_means)
ordered_study_ids <- selection_indices[order_indices]

ordered_means <- selected_means[order_indices]
ordered_ses   <- selected_ses[order_indices]
```

---

# 4. Marginal (BY05-adjusted) DP+ CIs

```{r}
dp_r <- 1.3

lower_marginal <- upper_marginal <- rep(NA, length(ordered_means))

for (i in seq_along(ordered_means)) {
  marginal_ci <- pp_marginal_ci(
    y     = ordered_means[i] / ordered_ses[i],
    r_l   = dp_r,
    alpha = length(selection_indices) * alpha / num_studies
  )

  lower_marginal[i] <- marginal_ci[1] * ordered_ses[i]
  upper_marginal[i] <- marginal_ci[2] * ordered_ses[i]
}

round(cbind(lower_marginal, upper_marginal), 3)
```

---

# 5. Conditional DP+ CIs

```{r}
lower_conditional <- upper_conditional <- rep(NA, length(ordered_means))

for (i in seq_along(ordered_means)) {
  cond_ci <- pp_conditional_ci(
    y     = ordered_means[i] / ordered_ses[i],
    r     = dp_r,
    ct    = qnorm(1 - alpha/2),
    alpha = alpha
  )

  lower_conditional[i] <- cond_ci[1] * ordered_ses[i]
  upper_conditional[i] <- cond_ci[2] * ordered_ses[i]
}

round(cbind(lower_conditional, upper_conditional), 3)
```

---

# 6. Combined Table

```{r}
results_table <- data.frame(
  study = ordered_study_ids,
  effect_mean = ordered_means,
  effect_se = ordered_ses,
  marginal_L = round(lower_marginal, 3),
  marginal_U = round(upper_marginal, 3),
  cond_L     = round(lower_conditional, 3),
  cond_U     = round(upper_conditional, 3)
)

results_table
```

---

# 7. Plot: Marginal vs Conditional DP+ CIs

```{r fig.width=12, fig.height=7}
plot_dp_forest(results_table)

```

---

