---
title: "Konstantopoulos (2011): Modified School Calendar Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Konstantopoulos (2011) Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(DirectedCI)
library(metafor)
library(dplyr)
```

# Helper: Combined CI Plotting Function

We provide a function that *plots both the marginal and conditional Direction-Preferring CIs together*.

```{r}
plot_dp_forest <- function(df,
                           study_id    = "study",
                           estimate    = "effect_mean",
                           se_var      = "effect_se",
                           marg_L      = "marginal_L",
                           marg_U      = "marginal_U",
                           cond_L      = "cond_L",
                           cond_U      = "cond_U",
                           title_label = "Direction-Preferring Confidence Intervals") {

  # Build a long-format CI table (mp/std/unadjusted not needed here)
  marginal_df <- df %>%
    mutate(type = "Marginal DP+",
           lower = .data[[marg_L]],
           upper = .data[[marg_U]],
           setting = "BY Adjusted CIs")

  conditional_df <- df %>%
    mutate(type = "Conditional DP+",
           lower = .data[[cond_L]],
           upper = .data[[cond_U]],
           setting = "Conditional CIs")

  # Combine them
  ci_long <- bind_rows(marginal_df, conditional_df) %>%
    mutate(setting = factor(setting,
                            levels = c("BY Adjusted CIs", "Conditional CIs"),
                            ordered = TRUE),
           type = factor(type, levels = c("Marginal DP+", "Conditional DP+")))

  # Colors (matching PDF figures)
  color_vec <- c("Marginal DP+" = "#00CED1",
                 "Conditional DP+" = "#000000")

  # Build the plot
  ggplot(ci_long,
         aes(x = factor(.data[[study_id]]),
             y = .data[[estimate]],
             color = type)) +

    geom_hline(yintercept = 0, linewidth = 0.6, alpha = 0.6) +

    geom_errorbar(aes(ymin = lower, ymax = upper),
                  position = position_dodge2(width = 0.8),
                  linewidth = 1.0) +

    geom_point(position = position_dodge2(width = 0.8),
               size = 3) +

    facet_grid(. ~ setting) +

    scale_color_manual(values = color_vec, name = "") +

    labs(
      x = "Study",
      y = expression(paste(theta)),
      title = title_label
    ) +

    theme_minimal(base_size = 16) +
    theme(
      legend.position   = "bottom",
      legend.title      = element_blank(),
      axis.text.x       = element_text(size = 12, hjust = 1),
      axis.text.y       = element_text(size = 12),
      axis.title        = element_text(size = 16),
      title             = element_text(size = 18, face = "bold"),
      strip.text        = element_text(size = 14),
      panel.spacing.x   = unit(2, "lines")
    ) +

    coord_flip()
}

```

---

# Quick Start: Using the CI Functions

This section demonstrates how to use the various confidence interval methods provided by the `DirectedCI` package.

## Basic Setup

All CI functions work with a single observation `y` and its standard deviation `sd`. They return a 2-element vector `c(lower, upper)` containing the lower and upper CI bounds.

```{r basic-example}
# Example: Observed estimate with SE
y <- 2.5    # Point estimate
sd <- 1.0   # Standard error

alpha <- 0.05
ct <- qnorm(1 - alpha/2)  # Critical value for selection (~1.96)
```

## Marginal (Unconditional) CIs

Marginal CIs are valid without conditioning on selection.

```{r marginal-cis}
# 1. Shortest (symmetric) CI - standard CI
shortest_marg <- shortest_marginal_ci_wrapper(y = y, sd = sd, alpha = alpha)
cat("Shortest Marginal CI:", round(shortest_marg, 3), "\n")

# 2. Modified Pratt CI (prefer positive direction)
# Note: r >= 1 for MP - larger r = more asymmetry toward preferred direction
mp_marg <- modified_pratt_marginal_ci(
  y = y, sd = sd, r = 1.5, alpha = alpha, direction = "positive"
)
cat("MP+ Marginal CI:     ", round(mp_marg, 3), "\n")
```

## Conditional CIs (After Selection)

Conditional CIs account for selection bias and require `|y/sd| > ct` (i.e., the result must be statistically significant).

```{r conditional-cis}
# Use a clearly significant observation
y_sig <- 3.0  # Significant at alpha=0.05 since |3.0/1.0| > 1.96
sd_sig <- 1.0

# 1. Shortest Conditional CI
shortest_cond <- shortest_conditional_ci_wrapper(
  y = y_sig, sd = sd_sig, ct = ct, alpha = alpha
)
cat("Shortest Conditional CI:", round(shortest_cond, 3), "\n")

# 2. Direction-Preferring Conditional CI
# Note: r >= 1 for conditional DP - larger r = more asymmetry
dp_cond <- direction_preferring_conditional_ci(
  y = y_sig, sd = sd_sig, ct = ct, r = 1.3, alpha = alpha, direction = "positive"
)
cat("DP+ Conditional CI:     ", round(dp_cond, 3), "\n")

# 3. Modified Pratt Conditional CI
mp_cond <- modified_pratt_conditional_ci(
  y = y_sig, sd = sd_sig, ct = ct, r = 1.3, alpha = alpha, direction = "positive"
)
cat("MP+ Conditional CI:     ", round(mp_cond, 3), "\n")
```

## Comparing All Methods

```{r comparison-table}
# Create comparison table for the significant observation
comparison <- data.frame(
  Method = c("Shortest Marginal", "MP+ Marginal (r=1.5)",
             "Shortest Conditional", "DP+ Conditional (r=1.3)", "MP+ Conditional (r=1.3)"),
  Lower = c(shortest_marg[1], mp_marg[1],
            shortest_cond[1], dp_cond[1], mp_cond[1]),
  Upper = c(shortest_marg[2], mp_marg[2],
            shortest_cond[2], dp_cond[2], mp_cond[2])
)
comparison$Width <- comparison$Upper - comparison$Lower
comparison[, 2:4] <- round(comparison[, 2:4], 3)
comparison
```

## Key Differences

- **Marginal vs Conditional**: Conditional CIs correct for selection bias but require significant observations (`|y/sd| > ct`)
- **Direction-Preferring (DP+)**: Asymmetric CIs that allocate more coverage probability to the preferred direction; lower bound is clamped at 0 for positive preference
- **Modified Pratt (MP)**: Alternative asymmetric CIs based on Pratt's approach; can extend the CI in the non-preferred direction
- **r parameter**: For conditional CIs, r >= 1 controls the inflation; larger r = more asymmetry toward the preferred direction

---

# 1. Introduction

We analyze the data in **Konstantopoulos (2011)**, which evaluated a *modified school calendar*
(shorter but more frequent academic breaks) and its influence on student performance.

Each study reports standardized mean differences following:

\[
X_i \sim N(\theta_i, 1).
\]

We construct confidence intervals using:

* **Marginal Direction-Preferring (DP+) CIs (BY05 adjusted)**
* **Conditional Direction-Preferring (DP+) CIs**

---

# 2. Loading and Preprocessing the Data

```{r}
dat <- get(data(dat.konstantopoulos2011))

# Standardized effects
standardized_effect <- as.vector(dat$yi / sqrt(dat$vi))

num_studies <- length(standardized_effect)
alpha <- 0.05

# Two-sided test p-values
p_right_tail <- pnorm(standardized_effect, lower.tail = FALSE)

selection_indices <- which(p_right_tail <= alpha/2 |
                           p_right_tail >= 1 - alpha/2)

length(selection_indices)
```

Extract mean and standard error for selected studies:

```{r}
selected_means <- as.vector(dat$yi)[selection_indices]
selected_ses   <- as.vector(sqrt(dat$vi))[selection_indices]
```

---

# 3. Ordering Studies for Display

```{r}
order_indices <- order(selected_means)
ordered_study_ids <- selection_indices[order_indices]

ordered_means <- selected_means[order_indices]
ordered_ses   <- selected_ses[order_indices]
```

---

# 4. Marginal (BY05-adjusted) DP+ CIs

```{r}
dp_r <- 1.3

lower_marginal <- upper_marginal <- rep(NA, length(ordered_means))

for (i in seq_along(ordered_means)) {
  marginal_ci <- dp_marginal_ci(
    y     = ordered_means[i] / ordered_ses[i],
    r_l   = dp_r,
    alpha = length(selection_indices) * alpha / num_studies
  )

  # CI is returned as c(lower, upper)
  lower_marginal[i] <- marginal_ci[1] * ordered_ses[i]
  upper_marginal[i] <- marginal_ci[2] * ordered_ses[i]
}

round(cbind(lower_marginal, upper_marginal), 3)
```

---

# 5. Conditional DP+ CIs

```{r}
lower_conditional <- upper_conditional <- rep(NA, length(ordered_means))

for (i in seq_along(ordered_means)) {
  cond_ci <- dp_conditional_ci(
    y     = ordered_means[i] / ordered_ses[i],
    r     = dp_r,
    ct    = qnorm(1 - alpha/2),
    alpha = alpha
  )

  # CI is returned as c(lower, upper)
  lower_conditional[i] <- cond_ci[1] * ordered_ses[i]
  upper_conditional[i] <- cond_ci[2] * ordered_ses[i]
}

round(cbind(lower_conditional, upper_conditional), 3)
```

---

# 6. Combined Table

```{r}
results_table <- data.frame(
  study = ordered_study_ids,
  effect_mean = ordered_means,
  effect_se = ordered_ses,
  marginal_L = round(lower_marginal, 3),
  marginal_U = round(upper_marginal, 3),
  cond_L     = round(lower_conditional, 3),
  cond_U     = round(upper_conditional, 3)
)

results_table
```

---

# 7. Plot: Marginal vs Conditional DP+ CIs

```{r fig.width=12, fig.height=7}
plot_dp_forest(results_table)

```

---

# 8. Comprehensive CI Comparison

The package provides a built-in `plot_ci_comparison` function that can compare multiple CI methods simultaneously, similar to the figures in the paper. This function computes and displays various CI methods including:

- **Standard**: Unadjusted symmetric CI
- **BY Standard**: BY05-adjusted symmetric CI
- **BY DP+**: BY05-adjusted direction-preferring CI
- **BY MP**: BY05-adjusted modified Pratt CI
- **Cond. Standard**: Conditional symmetric CI
- **Cond. DP+**: Conditional direction-preferring CI
- **Cond. MP**: Conditional modified Pratt CI

```{r fig.width=14, fig.height=8}
# Use the built-in plot_ci_comparison function
plot_ci_comparison(
  estimates = ordered_means,
  se = ordered_ses,
  names = as.character(ordered_study_ids),
  alpha = 0.05,
  m = num_studies,
  r = dp_r,
  ct = qnorm(1 - alpha/2),
  methods = c("standard", "by_standard", "by_dp", "by_mp",
              "cond_standard", "cond_dp", "cond_mp"),
  direction = "positive",
  title = "Konstantopoulos (2011): CI Method Comparison",
  xlab = "Standardized Mean Difference"
)
```

We can also create a focused comparison of just BY-adjusted vs Conditional DP+ CIs:

```{r fig.width=12, fig.height=6}
plot_ci_comparison(
  estimates = ordered_means,
  se = ordered_ses,
  names = as.character(ordered_study_ids),
  alpha = 0.05,
  m = num_studies,
  r = dp_r,
  ct = qnorm(1 - alpha/2),
  methods = c("by_dp", "cond_dp"),
  direction = "positive",
  show_facets = TRUE,
  title = "BY-Adjusted vs Conditional DP+ CIs"
)
```

---
